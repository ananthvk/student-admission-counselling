{% extends 'counselling/base.html' %}
{% load cache %}
{% block scripts %}
  {{ block.super }}
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
{% endblock %}
{% block content %}
  <div id="app">
    <h1 class="centered">Please fill your choices</h1>
    <div class="flex-container">
      <select name="choice" class="choice-entry-college choice-entry-select" size="10" :value="selected_college" @change="onSelectedCollegeChanged">
        <option disabled value="">Select a college</option>
        {% cache 3600 college_list_choice_entry %}
            {% for college in colleges %}
              <option value="{{ college.id }}">{{ college.code }} {{ college.name }}</option>
            {% endfor %}
        {% endcache %}
      </select>
      <select name="choice" class="choice-entry-course choice-entry-select" size="10" :value="selected_course" @change="onSelectedCourseChanged">
        <template v-for="course in courses" :key="course.id">
            <option :value="course.id" v-if="!choice_list_programs[selected_college] || !choice_list_programs[selected_college].includes(course.id)">
                [[course.code]] [[ course.name ]]
            </option>
            
        </template>
      </select>
        <div>
            <button @click="addProgram" class="primary-btn table-btn-blue">
                Add
            </button>
        </div>
    </div>
    <div class="flex-container">
        <button @click="postPrograms" class="primary-btn table-btn-blue" id="save-btn">
            Save choices
        </button>
    </div>
    <div>
        <table class="data-table">
          <tr class="data-header">
            <th class="data-th data-td-centered">Choice number</th>
            <th class="data-th data-td-centered">Code</th>
            <th class="data-th data-td-centered">College name</th>
            <th class="data-th data-td-centered">Course name</th>
            <th class="data-th data-td-centered">Action</th>
          </tr>
            <tr class="data-tr" v-for="(program,index) in priority_order" :key="`${program.college_id}{program.course_id}`">
              <td class="data-td data-td-centered">[[index + 1]]</td>
              <td class="data-td data-td-centered">[[program.college_code]][[program.course_code]]</td>
              <td class="data-td">[[program.college_name]]</td>
              <td class="data-td">[[program.course_name]]</td>
              <td class="data-td">
                  <button class="primary-btn table-btn table-btn-red" @click="deleteProgram(index)">Delete</button>
                  <button class="primary-btn table-btn table-btn-blue" @click="moveUp(index)">Move up</button>
                  <button class="primary-btn table-btn table-btn-blue" @click="moveDown(index)">Move down</button>
              </td>
            </tr>
        </table>
    </div>
  </div>
{% endblock %}
{% block closingscript %}
  <script>
    const { createApp, ref, onMounted } = Vue

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    
    createApp({
      setup() {
        const selected_college = ref('');
        const selected_college_name = ref('');

        const selected_course = ref('');
        const selected_course_name = ref('');

        const courses = ref({});
        const priority_order = ref([
            {% cache 3600 request.user.username request.user.student.last_choice_save_date %}
            {% for choice in choices %}
            {
                "college_id": {{ choice.program.college.id }},
                "course_id": {{ choice.program.course.id }},
                "college_name": "{{ choice.program.college.code }} {{ choice.program.college.name }}",
                "course_name": "{{ choice.program.course.name }}",
                "course_code": "{{ choice.program.course.code }}",
                "college_code": "{{ choice.program.college.code }}"
            },
            {% endfor %}
            {% endcache %}
        ]);
          
        // This contains the choice list of the student, example structure
        // {
        //      1: [....] // list of courses selected from college 1
        // }
        // This is used to hide courses from the select menu if they have already been added
        const choice_list_programs = ref({});

        onMounted(() => {
            priority_order.value.forEach(program => {
                const collegeId = program.college_id;
                const courseId = program.course_id;
    
                if (!choice_list_programs.value[collegeId]) {
                    choice_list_programs.value[collegeId] = [];
                }
                choice_list_programs.value[collegeId].push(courseId);
            });
        });
        
        function onSelectedCollegeChanged(e){
            // The selected college has changed, fetch courses from the api and update the other select box
            const selectedOption = e.target.options[e.target.selectedIndex];
            selected_college.value = e.target.value;
            selected_college_name.value = selectedOption.text;
            fetchPrograms(parseInt(selected_college.value));
        }
          
        function onSelectedCourseChanged(e){
            const selectedOption = e.target.options[e.target.selectedIndex];
            selected_course.value = e.target.value;
            selected_course_name.value = selectedOption.text;
        }
          
        function postPrograms(e)
        {
            let selected_programs = priority_order.value.map((program, index) => [index+1, program.college_id, program.course_id])
            const csrftoken = getCookie('csrftoken');
            document.getElementById("save-btn").disabled = true;
            fetch(`{% url 'counselling:choice_entry_post' %}`, {
                method: 'POST',
                body: JSON.stringify(selected_programs),
                headers: {
                    "X-CSRFToken": csrftoken
                }
            }).then(res => {
                if(!res.ok){
                    document.getElementById("save-btn").disabled = false;
                    alert('Error while saving program preferences, please try again later')
                    console.log(res)
                }
                else {
                    document.getElementById("save-btn").disabled = false;
                    alert('Successfully saved your choice list')
                }
            }).catch(err => {
                document.getElementById("save-btn").disabled = false;
                alert('Server error while saving preferences, please try again later')
                console.log(err)
            })
        }


        function fetchPrograms(college_id) {
          fetch(`{% url 'counselling:index' %}api/college/${college_id}/programs`)
            .then((response) => {
              if (!response.ok) {
                courses.value = {}
                throw new Error(`${response.status}`)
              }
              return response.json()
            })
            .then((data) => {
              // Filter the courses, do not show courses which have already been added
              if(choice_list_programs.value[college_id]){
                courses.value = data.courses; //filter(course => choice_list_programs.value[college_id].indexOf(course.id) == -1 )
              } else{
              courses.value = data.courses
              }

            })
            .catch((err) => {
              alert(`Network error, try again after some time ${err}`)
                courses.value = {}
            })
        }
        function deleteProgram(index) {
            let program = priority_order.value[index]
            priority_order.value.splice(index, 1);
            let idx = choice_list_programs.value[program.college_id].indexOf(program.course_id)
            choice_list_programs.value[program.college_id].splice(idx, 1);
            choice_list_programs.value = choice_list_programs.value
        }
        
        function moveUp(index) {
            if (index > 0) {
                const temp = priority_order.value[index];
                priority_order.value[index] = priority_order.value[index - 1];
                priority_order.value[index - 1] = temp;
            }
        }
        
        function moveDown(index) {
            if (index < priority_order.value.length - 1) {
                const temp = priority_order.value[index];
                priority_order.value[index] = priority_order.value[index + 1];
                priority_order.value[index + 1] = temp;
            }
        }
          
        function addProgram(e) {
            if(selected_college.value === ''){
                alert('Please select a college')
                return;
            }
            if(selected_course.value === ''){
                alert('Please select a course to add')
                return;
            }
            if(choice_list_programs.value[selected_college.value]){
                choice_list_programs.value[selected_college.value].push(parseInt(selected_course.value));
            } else{
                choice_list_programs.value[selected_college.value] = [parseInt(selected_course.value)];
            }
            
            // Don't show this course in the courses list
            // courses.value = courses.value.filter(course => course.id !== parseInt(selected_course.value))

            priority_order.value.push({
                "college_id": parseInt(selected_college.value),
                "course_id": parseInt(selected_course.value),
                "college_name": selected_college_name.value,
                "course_name": selected_course_name.value,
                "course_code": selected_course_name.value.split(" ")[0],
                "college_code": selected_college_name.value.split(" ")[0]
            })
            
            selected_course.value = '';
            selected_course_name.value = '';
        }

        return {
            selected_college,
            selected_course,
            onSelectedCollegeChanged,
            onSelectedCourseChanged,
            courses,
            addProgram,
            choice_list_programs,
            priority_order,
            deleteProgram,
            moveUp,
            moveDown,
            postPrograms
        }
      },
      delimiters: ['[[', ']]']
    }).mount('#app')
  </script>
{% endblock %}
